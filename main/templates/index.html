{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- PWA мета-теги -->
<meta name="application-name" content="Koinda">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Koinda">
<meta name="description" content="Приложение для учета личных финансов">
<meta name="format-detection" content="telephone=no">
<meta name="mobile-web-app-capable" content="yes">
<meta name="msapplication-TileColor" content="#3b82f6">
<meta name="msapplication-tap-highlight" content="no">
<meta name="theme-color" content="#3b82f6">

<!-- Apple Touch Icons -->
<link rel="apple-touch-icon" href="{% static 'main/icons/icon-152x152.png' %}">
<link rel="apple-touch-icon" sizes="152x152" href="{% static 'main/icons/icon-152x152.png' %}">
<link rel="apple-touch-icon" sizes="180x180" href="{% static 'main/icons/icon-192x192.png' %}">
<link rel="apple-touch-icon" sizes="167x167" href="{% static 'main/icons/icon-152x152.png' %}">

<!-- Manifest -->
<link rel="manifest" href="{% static 'main/manifest.json' %}">

<!-- Favicon -->
<link rel="icon" type="image/png" href="{% static 'main/icons/icon-32x32.png' %}" sizes="32x32">
<link rel="icon" type="image/png" href="{% static 'main/icons/icon-16x16.png' %}" sizes="16x16">

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Koinda - Учет расходов</title>
<meta name="theme-color" content="#0f172a">

<!-- CDN и локальные стили -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="{% static 'main/style.css' %}">
</head>

<body class="gradient-bg text-gray-100 min-h-screen">
<form style="display:none;">{% csrf_token %}</form>



    <!-- Верхний бар с балансом -->
    <div class="mobile-header">
        <div class="flex justify-between items-center mb-4">
            <!-- Логотип -->
            <div class="flex items-center relative">
                 <img id="logo1" src="{% static 'main/logo.svg' %}" alt="Koinda" class="h-8 transition-all duration-700">
                <img id="logo2" src="{% static 'main/ico.svg' %}" alt="Koinda" class="h-10 absolute opacity-0 blur-md transition-all duration-700">
            </div>
            
        <!-- Кнопка меню -->
<div class="flex items-center space-x-2 text-sm">
 <button id="menuToggleBtn" class="bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-lg flex items-center space-x-2">
  <i class="fas fa-bars text-gray-300"></i>
</button>


</div>

        </div>


<!-- Основной баланс -->
<div class="text-center">
    <p class="text-3xl font-bold mb-1" id="totalBalance">{{ total|floatformat:0 }} с</p>
    <div class="flex justify-center gap-6 text-sm">
        <div>
            <p class="text-gray-400">Доходы</p>
            <p class="income font-medium" id="monthIncome">{{ income|floatformat:0 }} с</p>
        </div>
        <div>
            <p class="text-gray-400">Расходы</p>
            <p class="expense font-medium" id="monthExpense">{{ expense|floatformat:0 }} с</p>
        </div>
    </div>
    
    <!-- Контейнер для уведомлений -->
    <div id="notificationContainer" class="absolute top-full left-0 right-0 mt-2 flex justify-center"></div>
</div>
    
    <!-- Контент приложения -->
    <div class="mobile-content">
        <!-- Главная вкладка -->
        <div class="mobile-tab active" id="tab-home">
            <div class="mobile-section">


            <!-- Вкладки категорий -->
<div class="card-gradient rounded-2xl p-1 mb-4">
    <div class="tabs-container" id="tabsContainer">
        <div class="tabs-wrapper" id="tabsWrapper">
            <!-- Вкладка "Все" -->
            <div class="tab active" data-category="all">
                <span>Все</span>
            </div>
            <!-- Вкладки категорий -->
            {% for category in categories %}
            <div class="tab" data-category="{{ category.id }}">
                <span>{{ category.name }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

                
<!-- История операций -->
<div class="card-gradient rounded-2xl p-4">
    <h2 class="text-lg font-bold mb-3">История операций</h2>
    
    <div class="space-y-3 overflow-y-auto" id="transactionsListContainer">
        {% if transactions %}
           <!-- В истории операций -->
{% for transaction in transactions %}
<div class="transaction-item bg-gray-800 rounded-lg p-3 flex justify-between items-center" 
     data-category-id="{{ transaction.category.id }}"
     data-transaction-id="{{ transaction.id }}">
    <div class="flex items-center space-x-3">
        <div class="w-10 h-10 rounded-full flex items-center justify-center" 
             style="background-color: {{ transaction.category.color }}22; color: {{ transaction.category.color }}">
            <i class="{{ transaction.category.icon }}"></i>
        </div>
        <div>
            <p class="font-medium">{{ transaction.category.name }}</p>
            {% if transaction.description %}
            <p class="text-xs text-gray-400">{{ transaction.description }}</p>
            {% endif %}
        </div>
    </div>
    <div class="flex items-center space-x-3">
        <div class="text-right">
            <p class="{% if transaction.type == 'income' %}text-green-400{% else %}text-red-400{% endif %} font-semibold">
                {% if transaction.type == 'income' %}+{% else %}-{% endif %}{{ transaction.amount|floatformat:0 }} с
            </p>
            <p class="text-xs text-gray-400">{{ transaction.created_at|date:"d.m.Y H:i" }}</p>
        </div>
        <!-- Кнопка удаления транзакции -->
        <button class="delete-transaction-btn text-red-400 hover:text-red-300 p-2 transition-colors" 
                data-transaction-id="{{ transaction.id }}"
                title="Удалить транзакцию">
            <i class="fas fa-trash text-sm"></i>
        </button>
    </div>
</div>
{% endfor %}
        {% else %}
            <div class="text-center py-8 text-gray-500" id="emptyStateAll">
                <i class="fas fa-receipt text-3xl mb-3"></i>
                <p>Операций пока нет</p>
            </div>
        {% endif %}
    </div>
    
    <!-- Пустое состояние для фильтрованных категорий (изначально скрыто) -->
    <div class="text-center py-8 text-gray-500 hidden" id="emptyStateFiltered">
        <i class="fas fa-receipt text-3xl mb-3"></i>
        <p>В этой категории операций пока нет</p>
    </div>
</div>
            </div>
        </div>
        
<!-- Категории вкладка -->
<div class="mobile-tab" id="tab-categories">
    <div class="mobile-section">
        <div class="card-gradient rounded-2xl p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">Мои категории</h2>
                <button class="text-blue-400 hover:text-blue-300 text-sm" id="addCategoryBtn">
                    <i class="fas fa-plus mr-1"></i> Добавить
                </button>
            </div>
            
            <div class="space-y-3 overflow-y-auto" id="categoriesList">
                <!-- Категории будут добавляться динамически -->
                <div class="text-center py-8 text-gray-500" id="emptyCategoriesState">
                    <i class="fas fa-tags text-3xl mb-3"></i>
                    <p>Категорий пока нет</p>
                </div>
            </div>
        </div>
    </div>
</div>
        <!-- Статистика вкладка -->
        <div class="mobile-tab" id="tab-stats">
            <div class="mobile-section">
                <div class="card-gradient rounded-2xl p-4 mb-4">
                    <h2 class="text-lg font-bold mb-3">Статистика</h2>
                    
                    <div class="space-y-4">
                        <div>
                            <p class="text-gray-400 text-sm">За неделю</p>
                            <div class="flex justify-between mt-1">
                                <span class="income">+ <span id="weekIncome">0</span> <span class="currency-symbol">с</span></span>
                                <span class="expense">- <span id="weekExpense">0</span> <span class="currency-symbol">с</span></span>
                            </div>
                        </div>
                        
                        <div>
                            <p class="text-gray-400 text-sm">За месяц</p>
                            <div class="flex justify-between mt-1">
                                <span class="income">+ <span id="monthIncomeStat">0</span> <span class="currency-symbol">с</span></span>
                                <span class="expense">- <span id="monthExpenseStat">0</span> <span class="currency-symbol">с</span></span>
                            </div>
                        </div>
                        
                        <div class="pt-4 border-t border-gray-700">
                            <p class="text-gray-400 text-sm">Самые частые категории</p>
                            <div class="mt-2 space-y-2" id="topCategories">
                                <!-- Топ категории будут здесь -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Быстрые действия -->
                <div class="card-gradient rounded-2xl p-4">
                    <h2 class="text-lg font-bold mb-3">Быстрые действия</h2>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg transition-colors flex flex-col items-center justify-center" id="exportBtn">
                            <i class="fas fa-file-export text-blue-400 text-lg mb-1"></i>
                            <span class="text-xs">Экспорт</span>
                        </button>
                        <button class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg transition-colors flex flex-col items-center justify-center" id="importBtn">
                            <i class="fas fa-file-import text-green-400 text-lg mb-1"></i>
                            <span class="text-xs">Импорт</span>
                        </button>
                        <button class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg transition-colors flex flex-col items-center justify-center" id="clearDataBtn">
                            <i class="fas fa-trash text-red-400 text-lg mb-1"></i>
                            <span class="text-xs">Очистить</span>
                        </button>
                        <a href="https://t.me/codifuse" class="bg-gray-800 hover:bg-gray-700 py-3 rounded-lg transition-colors flex flex-col items-center justify-center">
                            <i class="fa-brands fa-telegram text-blue-400 text-lg mb-1"></i>
                            <span class="text-xs">Поддержка</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Заметки вкладка -->
        <div class="mobile-tab" id="tab-notes">
            <div class="mobile-section">
                <div class="card-gradient rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Заметки</h2>
                        <button class="text-blue-400 hover:text-blue-300 text-sm add-note-btn">
                            <i class="fas fa-plus mr-1"></i> Добавить
                        </button>
                    </div>
                    
                    <div class="space-y-3 max-h-96 categories-scroll" id="notesList">
                        <div class="text-center py-8 text-gray-500" id="emptyNotesState">
                            <i class="fas fa-sticky-note text-3xl mb-3"></i>
                            <p>Заметок пока нет</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Нижнее меню навигации -->
    <div class="mobile-nav">
        <div class="mobile-nav-item active" data-tab="home">
            <i class="fas fa-home"></i>
            <span>Главная</span>
        </div>
        
        <div class="mobile-nav-item" data-tab="categories">
            <i class="fas fa-tags"></i>
            <span>Категории</span>
        </div>
        
        <div class="mobile-nav-center">
            <div class="mobile-nav-item-center" id="openTransactionModalBtn">
                <i class="fas fa-plus"></i>
            </div>
        </div>
        
        <div class="mobile-nav-item" data-tab="stats">
            <i class="fas fa-chart-pie"></i>
            <span>Статистика</span>
        </div>
        
        <div class="mobile-nav-item" data-tab="notes">
            <i class="fas fa-sticky-note"></i>
            <span>Заметки</span>
        </div>
    </div>

    <!-- Скрытый input для импорта -->
    <input type="file" id="importInput" accept=".json" class="hidden">

   <!-- Модальное окно добавления -->
<div id="transactionModal" class="fixed inset-0 hidden z-50 bg-black bg-opacity-60 flex items-center justify-center p-4">
  <div class="bg-gray-800 rounded-2xl w-full max-w-sm mx-auto">
    <!-- Заголовок -->
    <div class="p-4 border-b border-gray-700">
      <h2 class="text-xl font-bold text-center">Добавить запись</h2>
    </div>

    <form id="transactionForm" class="p-4 space-y-4">
      {% csrf_token %}
      <input type="hidden" name="category" id="selectedCategory">

     

      <!-- Поле суммы -->
      <div class="text-center">
        <input id="amountInput" name="amount" type="text" inputmode="decimal" required
               placeholder="0.00"
               class="w-full p-4 rounded-lg bg-gray-700 text-white text-center text-3xl font-bold border-2 border-gray-600 focus:border-blue-500 outline-none">
        <div class="text-xs text-gray-400 mt-1">Введите сумму</div>
      </div>

      <!-- Цифровая клавиатура -->
      <div class="grid grid-cols-3 gap-2">
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">1</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">2</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">3</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">4</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">5</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">6</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">7</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">8</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">9</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">00</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">0</button>
        <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">
          <i class="fas fa-backspace"></i>
        </button>
      </div>


       <!-- Тип операции -->
     <div class="flex gap-2">
    <button type="button" class="type-btn flex-1 py-3 rounded-lg font-semibold transition-all active:scale-95 bg-red-600 text-white border-2 border-red-600" data-type="expense">
        Расход
    </button>
    <button type="button" class="type-btn flex-1 py-3 rounded-lg font-semibold transition-all active:scale-95 bg-gray-700 text-gray-300 border-2 border-gray-600" data-type="income">
        Доход
    </button>
</div>


      <!-- Категории -->
      <div>
        <div class="text-sm text-gray-400 mb-2">Выберите категорию:</div>
        <div class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto p-1" id="categoriesContainer">
          <!-- Категории будут добавляться динамически -->
        </div>
      </div>

      <!-- Комментарий -->
      <div>
        <input id="descriptionInput" name="description" type="text" 
               placeholder="Комментарий (необязательно)"
               class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
      </div>

      <!-- Кнопки -->
      <div class="flex gap-3 pt-2">
        <button type="button" id="closeTransactionModalBtn" 
                class="flex-1 py-3 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors font-semibold">
          Отмена
        </button>
        <button type="submit" 
                class="flex-1 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors">
          Добавить
        </button>
      </div>
    </form>
  </div>
</div>


    </div>

    <!-- Модальное окно добавления категории -->
    <div id="categoryModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold">Новая категория</h2>
                    <button class="close-modal text-gray-400 hover:text-white text-xl" data-modal="category">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Название категории</label>
                        <input type="text" placeholder="Например: Одежда" class="input-field" id="categoryNameInput">
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 mb-2">Иконка</label>
                        <div class="grid grid-cols-4 gap-2" id="iconsGrid">
                            <!-- Иконки будут добавляться динамически -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 mb-2">Цвет</label>
                        <div class="grid grid-cols-5 gap-2" id="colorsGrid">
                            <!-- Цвета будут добавляться динамически -->
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button class="btn-secondary close-modal" data-modal="category">
                        Отмена
                    </button>
                    <button class="btn-primary" id="saveCategoryBtn">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно добавления/редактирования заметки -->
    <div id="noteModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold" id="noteModalTitle">Новая заметка</h2>
                    <button class="close-modal text-gray-400 hover:text-white text-xl" data-modal="note">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-gray-300 mb-2">Название заметки</label>
                        <input type="text" placeholder="Введите название" class="input-field" id="noteTitleInput">
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 mb-2">Текст заметки</label>
                        <textarea placeholder="Введите текст заметки" rows="6" class="input-field" id="noteContentInput"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button class="btn-secondary close-modal" data-modal="note">
                        Отмена
                    </button>
                    <button class="btn-primary" id="saveNoteBtn">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Модальное окно просмотра заметки -->
    <div id="viewNoteModal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="p-6">
                <div class="flex justify-between items-start mb-6">
                    <h2 class="text-2xl font-bold" id="viewNoteTitle"></h2>
                    <button class="close-modal text-gray-400 hover:text-white text-xl" data-modal="viewNote">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div class="note-content-container">
                        <p class="text-gray-200 whitespace-pre-wrap" id="viewNoteContent"></p>
                    </div>
                </div>
                
                <!-- Кнопки действий -->
                <div class="flex flex-col gap-3 mt-6">
                    <button class="btn-primary" id="editNoteBtn">
                        Редактировать
                    </button>
                    <div class="flex gap-3">
                       <button id="closeMenuBtn" class="mt-6 text-gray-400 hover:text-white">Закрыть</button>

                        <button class="btn-danger flex-1" id="deleteNoteBtn">
                            Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>


    
  <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-gray-800 rounded-2xl w-full max-w-sm mx-auto">
    <div class="p-6">
      <h2 class="text-2xl font-bold mb-6 text-center">Панель управления</h2>
      
      <!-- Уведомление о необходимости смены пароля -->
      {% if not user.userprofile.password_changed %}
      <div class="bg-red-500/20 border border-red-500/30 rounded-xl p-4 mb-4">
        <div class="flex items-start space-x-3">
          <i class="fas fa-exclamation-triangle text-red-400 mt-1"></i>
          <div>
            <p class="text-red-400 font-semibold text-sm">Смените пароль!</p>
            <p class="text-red-300 text-xs mt-1">
              Система создала временный пароль. Придумайте свой, чтобы не потерять доступ к данным.
            </p>
          </div>
        </div>
      </div>
      {% endif %}
      
      <!-- Блок информации о пользователе -->
      <div class="bg-gray-700 rounded-xl p-4 mb-6">
        <div class="flex items-center justify-between">
          <!-- Левая часть: аватар и информация -->
          <div class="flex items-center space-x-3">
            <!-- Аватар -->
            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
              <i class="fas fa-user text-white text-lg"></i>
            </div>
            
            <!-- Информация -->
            <div>
              <p class="font-bold text-white text-lg">{{ user.username }}</p>
              <p class="text-gray-300 text-sm">
                {% if user.email %}
                  {{ user.email }}
                {% else %}
                  email не указан
                {% endif %}
              </p>
            </div>
          </div>
          
          <!-- Правая часть: иконки действий -->
          <div class="flex items-center space-x-2">
            <!-- Иконка настроек (смена пароля) -->
            <button id="changePasswordBtn" class="w-10 h-10 rounded-full bg-gray-600 hover:bg-blue-600 flex items-center justify-center transition-colors group" title="Сменить пароль">
              <i class="fas fa-cog text-gray-300 group-hover:text-white transition-colors"></i>
            </button>
            
            <!-- Иконка выхода -->
            <a href="{% url 'logout' %}" class="w-10 h-10 rounded-full bg-gray-600 hover:bg-red-600 flex items-center justify-center transition-colors group" title="Выйти">
              <i class="fas fa-sign-out-alt text-gray-300 group-hover:text-white transition-colors"></i>
            </a>
          </div>
        </div>
      </div>
      
      
      <!-- Кнопка закрыть -->
      <button onclick="toggleMenuModal()" class="mt-6 w-full bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-medium transition-colors">
        Закрыть
      </button>
    </div>
  </div>
</div>


<!-- Модальное окно смены пароля -->
<div id="changePasswordModal" class="fixed inset-0 bg-black bg-opacity-60 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-gray-800 rounded-2xl w-full max-w-sm mx-auto">
    <div class="p-6">
      <h2 class="text-2xl font-bold mb-6 text-center">Смена пароля</h2>
      
      <form id="changePasswordForm" class="space-y-4">
        {% csrf_token %}
        <div>
          <input type="password" name="new_password" placeholder="Новый пароль" required 
                 class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
        </div>
        <div>
          <input type="password" name="confirm_password" placeholder="Повторите пароль" required 
                 class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
        </div>
        <button type="submit" class="btn-primary w-full py-3 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition-colors">
          Сохранить пароль
        </button>
      </form>
      
      <p id="passwordError" class="text-red-400 text-sm mt-2 hidden"></p>
      <p id="passwordSuccess" class="text-green-400 text-sm mt-2 hidden"></p>
      
      <button onclick="toggleChangePasswordModal()" class="mt-4 w-full text-gray-400 hover:text-white py-2 transition-colors">
        Отмена
      </button>
    </div>
  </div>
</div>

<script>
// Функции для управления модалкой смены пароля
function toggleChangePasswordModal() {
  const modal = document.getElementById('changePasswordModal');
  modal.classList.toggle('hidden');
  
  // Сбрасываем форму
  document.getElementById('changePasswordForm').reset();
  document.getElementById('passwordError').classList.add('hidden');
  document.getElementById('passwordSuccess').classList.add('hidden');
}

// Обработчик кнопки смены пароля
document.getElementById('changePasswordBtn').addEventListener('click', function() {
  toggleChangePasswordModal();
});

// Закрытие модалки по клику вне окна
document.getElementById('changePasswordModal').addEventListener('click', function(e) {
  if (e.target === this) {
    toggleChangePasswordModal();
  }
});

// AJAX смена пароля
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
  e.preventDefault();
  const form = e.target;
  const errorBox = document.getElementById('passwordError');
  const successBox = document.getElementById('passwordSuccess');
  
  errorBox.classList.add('hidden');
  successBox.classList.add('hidden');

  const formData = new FormData(form);
  const newPassword = formData.get('new_password');
  const confirmPassword = formData.get('confirm_password');
  const currentPassword = formData.get('current_password');

  // Валидация
  if (newPassword !== confirmPassword) {
    errorBox.textContent = "Пароли не совпадают";
    errorBox.classList.remove('hidden');
    return;
  }

  if (newPassword.length < 6) {
    errorBox.textContent = "Пароль должен быть не менее 6 символов";
    errorBox.classList.remove('hidden');
    return;
  }

  const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

  try {
    const response = await fetch("{% url 'change_password' %}", {
      method: "POST",
      headers: {
        'X-CSRFToken': csrfToken,
        'X-Requested-With': 'XMLHttpRequest'
      },
      body: formData
    });

    const data = await response.json();
    
    if (data.success) {
      successBox.textContent = data.message || "Пароль успешно изменен";
      successBox.classList.remove('hidden');
      
      // Закрываем модалки через 2 секунды и перезагружаем страницу
      setTimeout(() => {
        toggleChangePasswordModal();
        toggleMenuModal();
        location.reload(); // Перезагружаем чтобы обновить статус смены пароля
      }, 2000);
    } else {
      errorBox.textContent = data.error || "Ошибка при смене пароля";
      errorBox.classList.remove('hidden');
    }
  } catch (error) {
    console.error('Ошибка:', error);
    errorBox.textContent = "Произошла ошибка при отправке формы";
    errorBox.classList.remove('hidden');
  }
});
</script>

<script>
// Передаем категории из Django в JavaScript
window.categories = [
    {% for cat in categories %}
    {
        id: "{{ cat.id }}",
        name: "{{ cat.name|escapejs }}"
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
];

// Передача URL из Django в JavaScript
window.ADD_TRANSACTION_URL = "{% url 'add_transaction' %}";
window.STATIC_URL = "{% static '' %}";

// Передача балансов из Django в JavaScript
window.initialBalances = {
    total: {{ total }},
    income: {{ income }},
    expense: {{ expense }}
};

console.log('Инициализированы глобальные переменные:', {
    categories: window.categories,
    ADD_TRANSACTION_URL: window.ADD_TRANSACTION_URL,
    initialBalances: window.initialBalances
});



// Скрываем пустое состояние для фильтрованных категорий при загрузке
document.addEventListener("DOMContentLoaded", function() {
    const emptyStateFiltered = document.getElementById('emptyStateFiltered');
    if (emptyStateFiltered) {
        emptyStateFiltered.style.display = 'none';
    }
});


</script>
    <!-- Подключение Tailwind и JS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'main/app.js' %}"></script>
</body>
</html>