{% load static %}
<!DOCTYPE html>
<html lang="ru">
<head>
    <!-- PWA мета-теги -->
    <meta name="application-name" content="coinza">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="coinza">
    <meta name="description" content="Приложение для учета личных финансов">
    <meta name="format-detection" content="telephone=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="msapplication-TileColor" content="#3b82f6">
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="theme-color" content="#3b82f6">

    <!-- Apple Touch Icons -->
    <link rel="apple-touch-icon" href="{% static 'main/icons/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="152x152" href="{% static 'main/icons/icon-152x152.png' %}">
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'main/icons/icon-192x192.png' %}">
    <link rel="apple-touch-icon" sizes="167x167" href="{% static 'main/icons/icon-152x152.png' %}">

    <!-- Manifest -->
    <link rel="manifest" href="{% static 'main/manifest.json' %}">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="{% static 'main/icons/icon-32x32.png' %}" sizes="32x32">
    <link rel="icon" type="image/png" href="{% static 'main/icons/icon-16x16.png' %}" sizes="16x16">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coinza - Управляй финансами просто!</title>
    <meta name="theme-color" content="#0f172a">

    <!-- CDN и локальные стили -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'main/style.css' %}">
</head>

<body class="gradient-bg text-gray-100 min-h-screen">
    <form style="display:none;">{% csrf_token %}</form>

    <!-- Основной контейнер приложения -->
    <div class="app-container">
       <!-- Верхний бар с логотипом, уведомлением и меню -->
<!-- Хедер -->
<div class="mobile-header bg-gray-900 px-4 h-14 flex items-center justify-between">
  <div class="flex items-center h-full">
    <img id="logo2" src="{% static 'main/ico.svg' %}" alt="coinza" class="h-7">
    <span class="ml-1 text-[10px] text-gray-400 font-medium leading-none">v1.26</span>
  </div>
  
  <!-- Контейнер уведомлений ВНУТРИ хедера -->
  <div id="notificationContainer"></div>
  
  <button id="menuBtn" class="bg-gray-800 hover:bg-gray-700 h-full px-3 rounded-lg flex items-center justify-center">
    <i class="fas fa-bars text-gray-300"></i>
  </button>
</div>





        <!-- Главная вкладка -->
        <div class="mobile-tab active" id="tab-home">
            <div class="mobile-section">
                <div class="mobile-content">
                 <!-- Основной баланс — обновлённый дизайн -->
<div class="relative bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-2xl p-5 mb-4 mt-0 border border-blue-800/30 shadow-lg overflow-hidden">
    <!-- Большая фоновая иконка -->
    <i class="fas fa-dollar-sign text-[110px] text-blue-800/20 absolute top-3 right-4"></i>

    <div class="flex justify-between items-start relative z-10">
        <!-- Левая часть -->
        <div>
            <p class="text-sm text-gray-300 mb-1">Текущий баланс</p>
            <p class="text-3xl font-bold text-white">
                <span id="totalBalance" data-raw-value="{{ total|floatformat:0 }}">{{ total|floatformat:0 }}</span>
            </p>

            <!-- Резерв -->
            <div class="mt-3 flex items-center space-x-2">
                <span class="text-sm text-gray-300">Резерв:</span>
                <span class="text-blue-400 font-semibold text-lg" id="reserveAmount" data-raw-value="{{ current_reserve|floatformat:0 }}">{{ current_reserve|floatformat:0 }}</span>
                <span class="text-blue-400 text-sm">с</span>
            </div>
        </div>
    </div>

    <!-- Нижний блок — Доходы, Расходы, Шкала -->
    <div class="mt-5 relative z-10">
        <div class="flex justify-between items-end mb-2">
            <div class="text-left">
                <p class="text-xs text-gray-400 mb-1">Доходы</p>
                <p class="text-green-400 text-sm font-semibold" id="monthIncome" data-raw-value="{{ income|floatformat:0 }}">{{ income|floatformat:0 }} с</p>
            </div>
            <div class="text-right">
                <p class="text-xs text-gray-400 mb-1">Расходы</p>
                <p class="text-red-400 text-sm font-semibold" id="monthExpense" data-raw-value="{{ expense|floatformat:0 }}">{{ expense|floatformat:0 }} с</p>
            </div>
        </div>

        <!-- Прогресс-бар -->
        <div class="w-full bg-gray-700/50 rounded-full h-2 overflow-hidden">
            {% if income > 0 or expense > 0 %}
            <div class="flex h-2 rounded-full">
                <div class="bg-green-500 h-2 rounded-l-full"
                     style="width: {% widthratio income income|add:expense 100 %}%"></div>
                <div class="bg-red-500 h-2 rounded-r-full"
                     style="width: {% widthratio expense income|add:expense 100 %}%"></div>
            </div>
            {% else %}
            <div class="bg-gray-600 h-2 rounded-full"></div>
            {% endif %}
        </div>
    </div>
</div>
                    <!-- Вкладки категорий -->
                    <div class="card-gradient rounded-2xl p-1 mb-4">
                        <div class="tabs-container" id="tabsContainer">
                            <div class="tabs-wrapper" id="tabsWrapper">
                                <!-- Вкладка "Все" -->
                                <div class="tab active" data-category="all">
                                    <span>Все</span>
                                </div>
                                <!-- Вкладки категорий -->
                                {% for category in categories %}
                                <div class="tab" data-category="{{ category.id }}">
                                    <span>{{ category.name }}</span>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
<!-- История операций -->
<div class="card-gradient rounded-2xl p-4">
    <div class="flex justify-between items-center mb-3">
        <h2 class="text-lg font-bold">История операций</h2>
        <!-- Кнопка фильтра -->
        <div class="relative">
            <button id="filterToggleBtn" class="bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg text-sm flex items-center space-x-2 transition-colors">
                <span id="currentFilterText">За неделю</span>
                <i class="fas fa-chevron-down text-xs"></i>
            </button>
            <!-- Выпадающий список -->
            <div id="filterDropdown" class="absolute right-0 top-full mt-2 bg-gray-800 border border-gray-700 rounded-lg shadow-xl z-50 hidden min-w-40">
                <button class="filter-option w-full text-left px-4 py-3 hover:bg-gray-700 text-sm transition-colors border-b border-gray-700" data-filter="day">
                    <i class="fas fa-calendar-day mr-2"></i>За день
                </button>
                <button class="filter-option w-full text-left px-4 py-3 hover:bg-gray-700 text-sm transition-colors border-b border-gray-700" data-filter="week">
                    <i class="fas fa-calendar-week mr-2"></i>За неделю
                </button>
                <button class="filter-option w-full text-left px-4 py-3 hover:bg-gray-700 text-sm transition-colors" data-filter="month">
                    <i class="fas fa-calendar-alt mr-2"></i>За месяц
                </button>
            </div>
        </div>
    </div>
    
    <div class="space-y-3" id="transactionsListContainer">
        <!-- Транзакции будут загружаться динамически -->
    </div>
    
    <!-- Кнопка загрузки еще -->
    <div id="loadMoreContainer" class="mt-4 text-center hidden">
        <button id="loadMoreBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg text-sm transition-colors">
            Загрузить еще
        </button>
    </div>
    
    <!-- Пустые состояния -->
    <div class="text-center py-8 text-gray-500 hidden" id="emptyStateAll">
        <i class="fas fa-receipt text-3xl mb-3"></i>
        <p>Операций пока нет!</p>
    </div>
    
    <div class="text-center py-8 text-gray-500 hidden" id="emptyStateFiltered">
        <i class="fas fa-receipt text-3xl mb-3"></i>
        <p>В этой категории пусто!</p>
    </div>
</div>
                </div>
            </div>
        </div>
        
        <!-- Категории вкладка -->
        <div class="mobile-tab mt-5" id="tab-categories">
            <div class="mobile-section">
                <div class="card-gradient rounded-2xl p-4">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-icons text-blue-400 mr-2"></i>
                    Мои категории
                </h2>
                        <button class="text-blue-400 hover:text-blue-300 text-sm" id="addCategoryBtn">
                            <i class="fas fa-plus mb-3 mr-1"></i> Добавить
                        </button>
                    </div>
                    
                    <div class="space-y-3 overflow-y-auto" id="categoriesList">
                        <!-- Категории будут добавляться динамически -->
                        <div class="text-center py-8 text-gray-500" id="emptyCategoriesState">
                            <i class="fas fa-tags text-3xl mb-3"></i>
                            <p>Категорий пока нет</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

       <!-- Статистика вкладка - ПОЛНЫЙ РЕДИЗАЙН -->
<div class="mobile-tab" id="tab-stats">
    <div class="mobile-section">
        <div class="mobile-content">


     <!-- Обновленный блок "Резерв и сбережения" с новым дизайном -->
<div class="card-gradient rounded-2xl p-4 mb-4">
    <h2 class="text-lg font-bold mb-4 flex items-center">
        <i class="fas fa-piggy-bank text-blue-400 mr-2"></i>
        Резерв и сбережения
    </h2>
    
    <!-- Уведомление о выключенном резерве -->
    <div id="reserveNotification" class="mb-4 bg-gradient-to-r from-red-500/10 to-orange-500/10 rounded-xl p-4 border border-red-500/30 animate-fadeIn {% if reserve_percentage != 0 %}hidden{% endif %}">
        <div class="flex items-start space-x-3">
            <div class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center flex-shrink-0 mt-1">
                <i class="fas fa-exclamation-triangle text-red-400 text-lg"></i>
            </div>
            <div class="flex-1">
                <h3 class="font-semibold text-red-400 text-sm mb-1">Резерв отключен</h3>
                <p class="text-xs text-gray-300">
                    Функция автоматического резерва отключена. Включите ее в панели управления, 
                    чтобы откладывать процент от доходов автоматически.
                </p>
            </div>
        </div>
    </div>
    
    <div class="space-y-4">
        <!-- Текущий резерв -->
        <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 rounded-xl p-4 border border-blue-800/30">
            <div class="flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-300">Текущий резерв</p>
                    <p class="text-2xl font-bold text-blue-400 mt-1">
                        <span id="currentReserveAmount" data-raw-value="{{ current_reserve|floatformat:0 }}">{{ current_reserve|floatformat:0 }}</span> 
                        <span class="currency-symbol text-lg">с</span>
                    </p>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-300">Процент от доходов</p>
                    <p class="text-lg font-bold text-green-400 mt-1">
                        <span id="reservePercentageDisplay">{{ reserve_percentage }}</span>%
                    </p>
                </div>
            </div>
            
            
        </div>
        

            <!-- ОБНОВЛЕННЫЙ БЛОК ЦЕЛЕВОГО РЕЗЕРВА -->
<div class="bg-gradient-to-br from-purple-500/10 to-pink-500/10 rounded-xl p-4 border border-purple-500/20">
    <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-2">
            <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center">
                <i class="fas fa-bullseye text-purple-400"></i>
            </div>
            <div>
                <p class="text-sm font-semibold text-purple-400">Целевой резерв</p>
                <p class="text-xs text-gray-400">Ваша финансовая цель</p>
            </div>
        </div>
        <div class="text-right">
            <p class="text-lg font-bold text-purple-400">
                <span id="targetReserveAmount" data-raw-value="{{ target_reserve|floatformat:0 }}">{{ target_reserve|floatformat:0 }}</span> с
            </p>
        </div>
    </div>
    
    <!-- Интерактивный прогресс -->
    <div class="space-y-3">
        <div class="flex justify-between items-center">
            <span class="text-xs text-gray-400">Прогресс</span>
            <span class="text-xs font-bold text-yellow-400" id="remainingToTargetText">
                Осталось: <span id="remainingToTarget" data-raw-value="{{ remaining_to_target|floatformat:0 }}">{{ remaining_to_target|floatformat:0 }}</span> с
            </span>
        </div>
        
        <!-- Основной прогресс-бар -->
        <div class="w-full bg-gray-700 rounded-full h-3 relative overflow-hidden">
            <div id="targetProgressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all duration-1000 relative" 
                 style="width: {{ progress_percentage }}%">
                <!-- Анимация "сияния" на прогресс-баре -->
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/30 to-transparent animate-pulse-slow"></div>
            </div>
        </div>
        
        <!-- Дополнительная информация о прогрессе -->
        <div class="grid grid-cols-3 gap-2 text-center">
            <div class="text-xs text-gray-400">
                <div class="font-bold text-blue-400" id="targetCurrentReserve" data-raw-value="{{ current_reserve|floatformat:0 }}">{{ current_reserve|floatformat:0 }}</div>
                <div>Накоплено</div>
            </div>
            <div class="text-xs text-gray-400">
                <div class="font-bold text-yellow-400" id="targetRemaining" data-raw-value="{{ remaining_to_target|floatformat:0 }}">{{ remaining_to_target|floatformat:0 }}</div>
                <div>Осталось</div>
            </div>
            <div class="text-xs text-gray-400">
                <div class="font-bold text-green-400" id="targetProgressPercent">{{ progress_percentage|floatformat:1 }}%</div>
                <div>Выполнено</div>
            </div>
        </div>
    </div>
    
    <!-- Мотивационное сообщение -->
    <div class="mt-3 text-center" id="motivationMessage">
        {% if progress_percentage == 100 %}
        <div class="bg-gradient-to-r from-green-500/20 to-emerald-500/20 rounded-lg p-2 border border-green-500/30">
            <p class="text-xs text-green-400 font-semibold">
                <i class="fas fa-trophy mr-1"></i>Поздравляем! Цель достигнута!
            </p>
        </div>
        {% elif progress_percentage > 75 %}
        <p class="text-xs text-yellow-400 animate-pulse">
            <i class="fas fa-fire mr-1"></i>Осталось совсем немного!
        </p>
        {% elif progress_percentage > 50 %}
        <p class="text-xs text-blue-400">
            <i class="fas fa-rocket mr-1"></i>Отличный прогресс!
        </p>
        {% elif progress_percentage > 25 %}
        <p class="text-xs text-purple-400">
            <i class="fas fa-seedling mr-1"></i>Продолжайте в том же духе!
        </p>
        {% else %}
        <p class="text-xs text-gray-400">
            <i class="fas fa-flag mr-1"></i>Начните свой путь к цели
        </p>
        {% endif %}
    </div>
</div>


        <!-- ОБНОВЛЕННАЯ СТАТИСТИКА РЕЗЕРВА -->
        <div class="grid grid-cols-2 gap-3">
            <!-- Отложено в этом месяце - новый дизайн -->
            <div class="bg-gradient-to-br from-blue-500/10 to-blue-600/10 rounded-xl p-4 border border-blue-500/20 hover:border-blue-400/40 transition-all duration-300 group">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-calendar-plus text-blue-400 text-sm"></i>
                    </div>
                    <div class="text-right">
                        <div class="w-3 h-3 rounded-full bg-blue-400 animate-pulse"></div>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mb-1">Отложено в этом месяце</p>
                <p class="text-xl font-bold text-blue-400 group-hover:text-blue-300 transition-colors">
                    +<span id="monthlyReserveAmount" data-raw-value="{{ monthly_reserve|floatformat:0 }}">{{ monthly_reserve|floatformat:0 }}</span>
                </p>
                <div class="mt-2 w-full bg-blue-500/20 rounded-full h-1">
                    <div class="bg-blue-400 h-1 rounded-full transition-all duration-500" style="width: {% widthratio monthly_reserve current_reserve 100 %}%"></div>
                </div>
            </div>
            
            <!-- Всего накоплено - новый дизайн -->
            <div class="bg-gradient-to-br from-green-500/10 to-green-600/10 rounded-xl p-4 border border-green-500/20 hover:border-green-400/40 transition-all duration-300 group">
                <div class="flex items-center justify-between mb-2">
                    <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <i class="fas fa-chart-line text-green-400 text-sm"></i>
                    </div>
                    <div class="text-right">
                        <i class="fas fa-trophy text-green-400 text-sm"></i>
                    </div>
                </div>
                <p class="text-xs text-gray-400 mb-1">Всего накоплено</p>
                <p class="text-xl font-bold text-green-400 group-hover:text-green-300 transition-colors">
                    <span id="totalReserveAmount" data-raw-value="{{ current_reserve|floatformat:0 }}">{{ current_reserve|floatformat:0 }}</span>
                </p>
                <div class="mt-2 flex items-center space-x-1">
                    <div class="text-xs text-green-400">
                        <i class="fas fa-arrow-up"></i>
                    </div>
                    <div class="text-xs text-gray-400">растет каждый месяц</div>
                </div>
            </div>
        </div>

 
    </div>
</div>
            <!-- Анализ расходов по категориям -->
          
         <!-- 
<div class="card-gradient rounded-2xl p-4 mb-4">
    <h2 class="text-lg font-bold mb-4 flex items-center">
        <i class="fas fa-chart-pie text-purple-400 mr-2"></i>
        Анализ расходов
    </h2> 
    
    <div class="space-y-4">
        
        <div class="flex items-center justify-center py-4">
            <div class="relative w-40 h-40">
                
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="text-center">
                        <div class="text-2xl font-bold text-white" id="expensePercentage">0%</div>
                        <div class="text-xs text-gray-400">от доходов</div>
                    </div> 
                </div>
                <div class="w-40 h-40 rounded-full border-8 border-gray-700">
                    
                </div>
            </div>
        </div>
        
        
        <div class="space-y-3" id="expenseCategories">
            
            <div class="flex items-center justify-between p-3 bg-gray-800/40 rounded-xl">
                <div class="flex items-center">
                    <div class="w-3 h-3 rounded-full bg-red-500 mr-3"></div>
                    <div>
                        <p class="font-medium text-sm">Еда</p>
                        <p class="text-xs text-gray-400">35% расходов</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="font-bold text-red-400 text-sm">-2,450 <span class="currency-symbol text-xs">с</span></p>
                    <p class="text-xs text-gray-400">12 транзакций</p>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="card-gradient rounded-2xl p-4 mb-4">
    <h2 class="text-lg font-bold mb-4 flex items-center">
        <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
        Рекомендации
    </h2>
    
    <div class="space-y-3" id="recommendationsList">
        
        <div class="bg-gradient-to-r from-yellow-500/10 to-orange-500/10 rounded-xl p-3 border border-yellow-500/20">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 rounded-lg bg-yellow-500/20 flex items-center justify-center flex-shrink-0 mt-1">
                    <i class="fas fa-utensils text-yellow-400 text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-yellow-400 text-sm mb-1">Снижение расходов на еду</h3>
                    <p class="text-xs text-gray-300">
                        Вы тратите 35% доходов на еду. Попробуйте планировать покупки заранее.
                    </p>
                </div>
            </div>
        </div>
        
        
        <div class="bg-gradient-to-r from-blue-500/10 to-cyan-500/10 rounded-xl p-3 border border-blue-500/20">
            <div class="flex items-start space-x-3">
                <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center flex-shrink-0 mt-1">
                    <i class="fas fa-piggy-bank text-blue-400 text-sm"></i>
                </div>
                <div>
                    <h3 class="font-semibold text-blue-400 text-sm mb-1">Увеличьте резерв</h3>
                    <p class="text-xs text-gray-300">
                        Откладывайте 15% вместо 10% для быстрого достижения финансовой цели.
                    </p>
                </div>
            </div>
        </div>
    </div>
    
    
    <button class="w-full mt-4 bg-gray-800 hover:bg-gray-700 text-gray-300 py-3 rounded-xl text-sm font-medium transition-colors flex items-center justify-center">
        <i class="fas fa-robot mr-2"></i>
        Получить AI-рекомендации
    </button>
</div>


<div class="card-gradient rounded-2xl p-4">
    <h2 class="text-lg font-bold mb-4 flex items-center">
        <i class="fas fa-chart-bar text-green-400 mr-2"></i>
        Сравнение с прошлым периодом
    </h2>
    
    <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
            <div class="text-center">
                <p class="text-xs text-gray-400 mb-1">Текущий месяц</p>
                <div class="text-lg font-bold text-green-400">+15,000</div>
                <div class="text-xs text-gray-400">доходы</div>
            </div>
            
            <div class="text-center">
                <p class="text-xs text-gray-400 mb-1">Прошлый месяц</p>
                <div class="text-lg font-bold text-blue-400">+13,400</div>
                <div class="text-xs text-gray-400">доходы</div>
            </div>
        </div>
        
        <div class="bg-gray-800/40 rounded-xl p-3">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-300">Рост доходов</span>
                <span class="text-sm font-bold text-green-400">+12%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-green-500 h-2 rounded-full" style="width: 65%"></div>
            </div>
        </div>
        
        <div class="bg-gray-800/40 rounded-xl p-3">
            <div class="flex justify-between items-center mb-2">
                <span class="text-sm text-gray-300">Снижение расходов</span>
                <span class="text-sm font-bold text-red-400">-5%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="bg-red-500 h-2 rounded-full" style="width: 35%"></div>
            </div>
        </div>
    </div>
</div>
-->
        </div>
    </div>
</div> 
        
<!-- Заметки вкладка -->
<div class="mobile-tab" id="tab-notes">
    <div class="mobile-section">
      <div class="mobile-content">
        <div class="card-gradient rounded-2xl p-4">
            <div class="flex justify-between items-center mb-4">
                 <h2 class="text-lg font-bold mb-4 flex items-center">
                    <i class="fa-solid fa-feather-pointed text-blue-400 mr-2"></i>
                    Умные заметки
                </h2>
                <button class="text-blue-400 hover:text-blue-300 text-sm mb-3 add-note-btn">
                    <i class="fas fa-plus mr-1"></i> Добавить
                </button>
            </div>
            
            <div class="space-y-3 max-h-96 categories-scroll" id="notesList">
                <!-- ЗАМЕНИТЕ ЭТОТ БЛОК НА НОВЫЙ ДИЗАЙН -->
                <div class="text-center py-6 px-4" id="emptyNotesState">
                    <!-- Главная иконка -->
                    <div class="w-20 h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-blue-500/20 to-purple-600/20 flex items-center justify-center">
                        <i class="fas fa-sticky-note text-3xl text-blue-400"></i>
                    </div>
                    
                    <!-- Заголовок -->
                    <h3 class="text-xl font-bold text-white mb-3">Ваши умные заметки</h3>
                    
                    <!-- Описание -->
                    <p class="text-gray-400 text-sm mb-6 max-w-sm mx-auto">
                        Создавайте заметки с напоминаниями и никогда не упускайте важное
                    </p>
                    
                    <!-- Преимущества в виде карточек -->
                    <div class="grid gap-3 mb-6">
                        <!-- Напоминания -->
                        <div class="flex items-start space-x-3 p-3 bg-gray-800/40 rounded-xl border border-gray-700/50">
                            <div class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-bell text-blue-400 text-sm"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-white text-sm font-semibold">Умные напоминания</h4>
                                <p class="text-gray-400 text-xs">Получайте уведомления точно в срок</p>
                            </div>
                        </div>
                        
                        <!-- Организация -->
                        <div class="flex items-start space-x-3 p-3 bg-gray-800/40 rounded-xl border border-gray-700/50">
                            <div class="w-8 h-8 rounded-lg bg-green-500/20 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-layer-group text-green-400 text-sm"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-white text-sm font-semibold">Все под контролем</h4>
                                <p class="text-gray-400 text-xs">Просматривайте и редактируйте в любое время</p>
                            </div>
                        </div>
                        
                        <!-- Быстрый доступ -->
                        <div class="flex items-start space-x-3 p-3 bg-gray-800/40 rounded-xl border border-gray-700/50">
                            <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-rocket text-purple-400 text-sm"></i>
                            </div>
                            <div class="text-left">
                                <h4 class="text-white text-sm font-semibold">Мгновенный доступ</h4>
                                <p class="text-gray-400 text-xs">Ваши мысли всегда под рукой</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Призыв к действию -->
                   <button class="add-note-btn w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-semibold py-3 px-6 rounded-xl transition-all duration-200 transform hover:scale-105 active:scale-95 shadow-lg"
        onclick="openAddNoteModal()">
    <i class="fas fa-plus mr-2"></i>
    Создать первую заметку
</button>
                    
                    <!-- Дополнительная мотивация -->
                    <p class="text-gray-500 text-xs mt-4">
                        Уже <span class="text-blue-400 font-semibold">127</span> пользователей записали свои мысли
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
</div>


    <!-- Нижнее меню навигации -->
<div class="mobile-nav">
    <div class="mobile-nav-item active" data-tab="home">
        <i class="fas fa-home"></i>
        <span>Главная</span>
    </div>
    
    <div class="mobile-nav-item" data-tab="categories">
        <i class="fas fa-tags"></i>
        <span>Категории</span>
    </div>
    
    <div class="mobile-nav-center">
        <!-- Подсказка для нового пользователя -->
       <!-- Просто замените блок welcomeHint на этот -->
{% if not has_transactions %}
<!-- Просто замените блок welcomeHint на этот -->
<div id="welcomeHint" class="fixed bottom-20 inset-x-0 text-center animate-bounce z-50 {% if has_transactions %}hidden{% endif %}">
    <div class="bg-blue-600 text-white text-sm rounded-lg py-2 px-3 mb-1 inline-block shadow-lg">
        Сделай первую транзакцию!
    </div>
    <div class="text-white text-2xl">↓</div>
</div>
{% endif %}
        
        <div class="mobile-nav-item-center" id="openTransactionModalBtn">
            <i class="fas fa-plus"></i>
        </div>
    </div>
    
    <div class="mobile-nav-item" data-tab="stats">
        <i class="fas fa-chart-pie"></i>
        <span>Статистика</span>
    </div>
    
    <div class="mobile-nav-item" data-tab="notes">
        <i class="fas fa-sticky-note"></i>
        <span>Заметки</span>
    </div>
</div>

        <!-- Скрытый input для импорта -->
        <input type="file" id="importInput" accept=".json" class="hidden">
  
    </div> <!-- Конец .app-container -->

    <!-- Модальное окно добавления транзакции -->
    <div id="transactionModal" class="fixed inset-0 backdrop-blur-sm hidden z-[1000] bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content bg-gray-800 rounded-2xl w-full max-w-sm mx-auto">
            <!-- Заголовок -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-center">Добавить запись</h2>
            </div>

            <form id="transactionForm" class="p-4 space-y-4">
                {% csrf_token %}
                <input type="hidden" name="category" id="selectedCategory">

                <!-- Поле суммы -->
                <div class="text-center">
                    <input id="amountInput" name="amount" type="text" inputmode="decimal" required
                           placeholder="0.00"
                           class="w-full p-4 rounded-lg bg-gray-700 text-white text-center text-3xl font-bold border-2 border-gray-600 focus:border-blue-500 outline-none">
                    <div class="text-xs text-gray-400 mt-1">Введите сумму</div>
                </div>

                <!-- Цифровая клавиатура -->
                <div class="grid grid-cols-3 gap-2">
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">1</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">2</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">3</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">4</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">5</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">6</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">7</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">8</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">9</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">00</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">0</button>
                    <button type="button" class="keypad-btn bg-gray-700 hover:bg-gray-600 active:bg-gray-500 p-3 rounded-lg text-xl font-medium transition-all active:scale-95">
                        <i class="fas fa-backspace"></i>
                    </button>
                </div>

                <!-- Тип операции -->
                <div class="flex gap-2">
                    <button type="button" class="type-btn flex-1 py-3 rounded-lg font-semibold transition-all active:scale-95 bg-red-600 text-white border-2 border-red-600" data-type="expense">
                        Расход
                    </button>
                    <button type="button" class="type-btn flex-1 py-3 rounded-lg font-semibold transition-all active:scale-95 bg-gray-700 text-gray-300 border-2 border-gray-600" data-type="income">
                        Доход
                    </button>
                </div>

                <!-- Категории -->
                <div>
                    <div class="text-sm text-gray-400 mb-2">Выберите категорию:</div>
                    <div class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto p-1" id="categoriesContainer">
                        <!-- Категории будут добавляться динамически -->
                    </div>
                </div>

                <!-- Комментарий -->
                <div>
                    <input id="descriptionInput" name="description" type="text" 
                           placeholder="Комментарий (необязательно)"
                           class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                </div>

                <!-- Кнопки -->
                <div class="flex gap-3 pt-2">
                    <button type="button" id="closeTransactionModalBtn" 
                            class="flex-1 py-3 rounded-lg bg-gray-700 text-gray-300 hover:bg-gray-600 transition-colors font-semibold">
                        Отмена
                    </button>
                    <button type="submit" 
                            class="flex-1 py-3 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold transition-colors">
                        Добавить
                    </button>
                </div>
            </form>
        </div>
    </div>






 <div id="categoryModal" class="fixed inset-0 backdrop-blur-sm hidden z-[1000] bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content bg-gray-800 rounded-2xl w-full max-w-sm mx-auto">
          
            <!-- Заголовок -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-center">Добавить категорию</h2>
            </div>

            <div class="p-6">
          
                
                <div class="space-y-4">
                    <div>
                     
                        <input type="text" placeholder="Название категории" class="input-field" id="categoryNameInput">
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 mb-2">Иконка</label>
                        <div class="grid grid-cols-4 gap-2" id="iconsGrid">
                            <!-- Иконки будут добавляться динамически -->
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-gray-300 mb-2">Цвет</label>
                        <div class="grid grid-cols-5 gap-2" id="colorsGrid">
                            <!-- Цвета будут добавляться динамически -->
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end gap-3 mt-6">
                    <button class="btn-secondary close-modal" data-modal="category">
                        Отмена
                    </button>
                    <button class="btn-primary" id="saveCategoryBtn" type="button">
                        Сохранить
                    </button>
                </div>
            </div>
        </div>
    </div>


<div id="noteModal" class="fixed inset-0 backdrop-blur-sm hidden z-[1000] bg-black bg-opacity-60 flex items-center justify-center p-4">
        <div class="modal-content bg-gray-800 rounded-2xl w-full max-w-sm mx-auto">
          
            <!-- Заголовок -->
            <div class="p-4 border-b border-gray-700">
                <h2 class="text-xl font-bold text-center" id="noteModalTitle">Новая заметка</h2>
            </div>

            <div class="p-6">

            
            <div class="space-y-4">
                <div>
                   
                    <input type="text" placeholder="Введите название" class="input-field" id="noteTitleInput">
                </div>
                
                <div>
                  
                    <textarea placeholder="Введите текст заметки" rows="6" class="input-field" id="noteContentInput"></textarea>
                </div>
                
                <!-- Добавленное поле для даты напоминания -->
                <!-- Добавленное поле для даты напоминания -->
<div>
    <label class="block text-gray-300 mb-2">
        <i class="fas fa-bell mr-2 text-blue-400"></i>
        Дата напоминания (необязательно)
    </label>
    <input type="datetime-local" class="input-field" id="reminderDateInput">
    <p class="text-xs text-gray-400 mt-1">
        Оставьте пустым, если напоминание не нужно. Время указывается в вашем локальном часовом поясе.
    </p>
</div>
            </div>
            
            <div class="flex justify-end gap-3 mt-6">
                <button class="btn-secondary close-modal" data-modal="note">
                    Отмена
                </button>
                <button class="btn-primary w-full py-3" id="saveNoteBtn">
    Сохранить
</button>
            </div>
        </div>
    </div>
</div>

  <!-- Модальное окно просмотра заметки -->
<div id="viewNoteModal" class="modal-overlay z-50 hidden">
    <div class="modal-content max-w-2xl">
        <div class="p-6">
            <!-- Заголовок без крестика -->
            <div class="mb-4">
                <h2 class="text-2xl font-bold text-white mb-2" id="viewNoteTitle"></h2>
                <!-- Дата создания будет добавляться динамически -->
            </div>
            
            <div class="space-y-4">
                <!-- Блок напоминания -->
                <div id="viewNoteReminderInfo" class="hidden">
                    <div class="flex items-center px-3 py-2 bg-blue-500/20 rounded-lg border border-blue-500/30">
                        <i class="fas fa-bell text-blue-400 mr-2"></i>
                        <span class="text-blue-400 text-sm" id="viewNoteReminderDate"></span>
                    </div>
                </div>
                
                <!-- Контент заметки -->
                <div class="note-content-container bg-gray-700/30 rounded-lg p-4 border border-gray-600">
                    <p class="text-gray-200 whitespace-pre-wrap text-lg" id="viewNoteContent"></p>
                </div>
            </div>
            
            <!-- Кнопки действий в одну линию -->
            <div class="flex gap-3 mt-6">
                <button class="btn-secondary flex-1 py-3" id="closeViewNoteBtn">
                    Закрыть
                </button>
                <button class="btn-primary flex-1 py-3" id="editNoteBtn">
                    Редактировать
                </button>
                <!-- Кнопка удаления скрыта, чтобы не было ошибок в JS -->
                <button class="btn-danger flex-1 py-3 hidden" id="deleteNoteBtn" style="display: none !important;">
                    <i class="fas fa-trash mr-2"></i>Удалить
                </button>
                <button class="btn-secondary flex-1 py-3 hidden" id="hideReminderBtn" style="display: none !important;">
                    <i class="fas fa-eye-slash mr-2"></i>Скрыть
                </button>
            </div>
        </div>
    </div>
</div>

    <!-- Модальное окно меню -->
    <div id="menuModal" class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-gray-800 rounded-2xl w-full max-w-sm mx-auto">
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-6 text-center">Панель управления</h2>
                
                <!-- Уведомление о необходимости смены пароля -->
                {% if not user.userprofile.password_changed %}
                <div class="bg-red-500/20 border border-red-500/30 rounded-xl p-4 mb-4">
                    <div class="flex items-start space-x-3">
                        <i class="fas fa-exclamation-triangle text-red-400 mt-1"></i>
                        <div>
                            <p class="text-red-400 font-semibold text-sm">Смените пароль!</p>
                            <p class="text-red-300 text-xs mt-1">
                                Система создала временный пароль. Придумайте свой, чтобы не потерять доступ к данным.
                            </p>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                <!-- Блок информации о пользователе -->
                <div class="bg-gray-700 rounded-xl p-4 mb-6">
                    <div class="flex items-center justify-between">
                        <!-- Левая часть: аватар и информация -->
                        <div class="flex items-center space-x-3">
                            <!-- Аватар -->
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
                                <i class="fas fa-user text-white text-lg"></i>
                            </div>
                            
                            <!-- Информация -->
                            <div>
                                <p class="font-bold text-white text-lg">{{ user.username }}</p>
                                <p class="text-gray-300 text-sm">
                                    {% if user.email %}
                                        {{ user.email }}
                                    {% else %}
                                        email не указан
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        
                        <!-- Правая часть: иконки действий -->
                        <div class="flex items-center space-x-2">
                            <!-- Иконка настроек (смена пароля) -->
                            <button id="changePasswordBtn" class="w-10 h-10 rounded-full bg-gray-600 hover:bg-blue-600 flex items-center justify-center transition-colors group" title="Сменить пароль">
                                <i class="fas fa-cog text-gray-300 group-hover:text-white transition-colors"></i>
                            </button>
                            
                            <!-- Иконка выхода -->
                            <a href="{% url 'logout' %}" class="w-10 h-10 rounded-full bg-gray-600 hover:bg-red-600 flex items-center justify-center transition-colors group" title="Выйти">
                                <i class="fas fa-sign-out-alt text-gray-300 group-hover:text-white transition-colors"></i>
                            </a>
                        </div>
                    </div>
                </div>
                
  <!-- Настройка процента резерва -->
<div class="bg-gray-700/60 rounded-xl p-4 mb-6 border border-gray-600/50">
    <div class="flex items-center justify-between mb-3">
        <div class="flex items-center space-x-2">
            <div class="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center">
                <i class="fas fa-piggy-bank text-blue-400 text-sm"></i>
            </div>
            <h3 class="text-base font-semibold text-gray-200">Резерв</h3>
        </div>
        <span id="currentReservePercent" class="text-sm text-blue-400 font-medium">{{ reserve_percentage }}%</span>
    </div>

    <p class="text-sm text-gray-400 mb-3">
        Укажите, сколько процентов от доходов автоматически откладывать в резерв.
    </p>

    <div class="flex items-center space-x-3 mb-4">
        <input
            type="number"
            id="reservePercentageInput"
            min="0"
            max="100"
            class="w-24 bg-gray-800 border border-gray-700 rounded-lg p-2 text-center text-white text-lg font-semibold focus:border-blue-500 focus:ring-0 outline-none transition-all"
            value="{{ reserve_percentage }}" 
        >
        <button
            id="saveReserveBtn"
            class="flex-1 bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all"
        >
            <i class="fas fa-save mr-2"></i>Сохранить
        </button>
    </div>



    <!-- Новый блок для целевого резерва -->
    <div class="pt-4 border-t border-gray-600/50">
        <div class="flex items-center justify-between mb-3">
            <div class="flex items-center space-x-2">
                <div class="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center">
                    <i class="fas fa-bullseye text-purple-400 text-sm"></i>
                </div>
                <h3 class="text-base font-semibold text-gray-200">Целевой резерв</h3>
            </div>
            <span id="currentTargetReserve" class="text-sm text-purple-400 font-medium">{{ target_reserve|floatformat:0 }} с</span>
        </div>

        <p class="text-sm text-gray-400 mb-3">
            Укажите сумму, которую хотите накопить.
        </p>

        <div class="flex items-center space-x-3">
            <input
                type="number"
                id="targetReserveInput"
                min="0"
                step="1000"
                class="w-24 bg-gray-800 border border-gray-700 rounded-lg p-2 text-center text-white text-lg font-semibold focus:border-purple-500 focus:ring-0 outline-none transition-all"
                value="{{ target_reserve|floatformat:0 }}"
            >
            <button
                id="saveTargetReserveBtn"
                class="flex-1 bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded-lg text-sm font-medium transition-all"
            >
                <i class="fas fa-save mr-2"></i>Сохранить
            </button>
        </div>
    </div>
    
</div>


<button onclick="toggleMenuModal()" class="mt-6 w-full bg-gray-700 hover:bg-gray-600 text-white py-3 rounded-lg font-medium transition-colors">
                    Закрыть
                </button>


    <!-- Модальное окно смены пароля -->
    <div id="changePasswordModal"
     class="fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm hidden z-[1000] flex items-center justify-center p-4">
    <div class="modal-content bg-gray-800 rounded-2xl w-full max-w-sm mx-auto p-6">
        <h2 class="text-xl font-bold mb-4 text-center">Смена пароля</h2>
                
                <form id="changePasswordForm" class="space-y-4">
                    {% csrf_token %}
                    
                    <!-- Поле для текущего пароля (если уже меняли) -->
                    <div id="currentPasswordField" class="hidden">
                        <input type="password" name="current_password" placeholder="Текущий пароль" 
                               class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                    
                    <div>
                        <input type="password" name="new_password" placeholder="Новый пароль" required 
                               class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <input type="password" name="confirm_password" placeholder="Повторите пароль" required 
                               class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:border-blue-500 outline-none">
                    </div>
                    
                    <!-- Кнопка с состоянием загрузки -->
                    <button type="submit" class="change-password-submit-btn btn-primary w-full py-3 rounded-lg text-white font-semibold relative overflow-hidden">
                        <span class="change-password-btn-text">Сохранить пароль</span>
                        <div class="change-password-spinner hidden absolute inset-0 flex items-center justify-center">
                            <div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                        </div>
                    </button>
                </form>
                
                <button onclick="toggleChangePasswordModal()" class="mt-4 w-full text-gray-400 hover:text-white py-2 transition-colors">
                    Отмена
                </button>
            </div>
        </div>
    </div>

<!-- index.html - обновляем блок с балансом -->
<script>
    window.initialBalances = {
        total: {{ total|default:0 }},
        income: {{ income|default:0 }},
        expense: {{ expense|default:0 }},
        total_reserve: {{ current_reserve|default:0 }},
        monthly_reserve: {{ monthly_reserve|default:0 }}  // добавляем месячный резерв
    };
    window.initialReservePercentage = {{ reserve_percentage|default:0 }};
    window.initialTargetReserve = {{ target_reserve|default:0 }};
</script>

<!-- Подключение Tailwind и JS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="{% static 'main/app.js' %}"></script>
    <script src="{% static 'main/notes.js' %}"></script>


    <script>
        // Переменная для отслеживания первой смены пароля
        let isFirstPasswordChange = {% if not user.userprofile.password_changed %}true{% else %}false{% endif %};

        // Функции для управления модалкой смены пароля
        function toggleChangePasswordModal() {
            const modal = document.getElementById('changePasswordModal');
            modal.classList.toggle('hidden');
            
            // Сбрасываем форму
            document.getElementById('changePasswordForm').reset();
            
            // Сбрасываем состояние кнопки
            setChangePasswordButtonLoading(false);
            document.querySelector('.change-password-submit-btn').classList.add('btn-primary');
            document.querySelector('.change-password-submit-btn').classList.remove('bg-red-600', 'cursor-not-allowed', 'bg-green-600');
        }

        // Функции для управления состоянием кнопки смены пароля
        function setChangePasswordButtonLoading(isLoading) {
            const btn = document.querySelector('.change-password-submit-btn');
            const btnText = btn.querySelector('.change-password-btn-text');
            const spinner = btn.querySelector('.change-password-spinner');
            
            if (btn && btnText && spinner) {
                if (isLoading) {
                    btn.disabled = true;
                    btnText.classList.add('opacity-0');
                    spinner.classList.remove('hidden');
                } else {
                    btn.disabled = false;
                    btnText.classList.remove('opacity-0');
                    spinner.classList.add('hidden');
                }
            }
        }

        function showChangePasswordButtonError(errorMessage) {
            const btn = document.querySelector('.change-password-submit-btn');
            const btnText = btn.querySelector('.change-password-btn-text');
            const spinner = btn.querySelector('.change-password-spinner');
            
            if (btn && btnText && spinner) {
                // Сохраняем оригинальный текст
                const originalText = btnText.textContent;
                
                // Показываем ошибку
                btn.disabled = true;
                spinner.classList.add('hidden');
                btnText.classList.remove('opacity-0');
                btnText.textContent = errorMessage;
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-red-600', 'cursor-not-allowed');
                
                // Через 4 секунды возвращаем нормальное состояние
                setTimeout(() => {
                    btn.disabled = false;
                    btnText.textContent = originalText;
                    btn.classList.add('btn-primary');
                    btn.classList.remove('bg-red-600', 'cursor-not-allowed');
                }, 2000);
            }
        }

        function showChangePasswordButtonSuccess(successMessage) {
            const btn = document.querySelector('.change-password-submit-btn');
            const btnText = btn.querySelector('.change-password-btn-text');
            const spinner = btn.querySelector('.change-password-spinner');
            
            if (btn && btnText && spinner) {
                // Показываем успех
                btn.disabled = true;
                spinner.classList.add('hidden');
                btnText.classList.remove('opacity-0');
                btnText.textContent = successMessage;
                btn.classList.remove('btn-primary');
                btn.classList.add('bg-green-600', 'cursor-not-allowed');
                
                // Только при первой смене пароля закрываем модалки и перезагружаем страницу
                if (isFirstPasswordChange) {
                    setTimeout(() => {
                        toggleChangePasswordModal();
                        toggleMenuModal();
                        location.reload();
                    }, 2000);
                } else {
                    // При повторной смене просто сбрасываем форму через 2 секунды
                    setTimeout(() => {
                        document.getElementById('changePasswordForm').reset();
                        setChangePasswordButtonLoading(false);
                        btn.classList.add('btn-primary');
                        btn.classList.remove('bg-green-600', 'cursor-not-allowed');
                        btnText.textContent = "Сохранить пароль";
                    }, 2000);
                }
            }
        }

        // Обработчик кнопки смены пароля
        document.getElementById('changePasswordBtn').addEventListener('click', function() {
            toggleChangePasswordModal();
            
            // Показываем поле для текущего пароля, если пользователь уже менял пароль
            const currentPasswordField = document.getElementById('currentPasswordField');
            if ({{ user.userprofile.password_changed|yesno:"true,false" }}) {
                currentPasswordField.classList.remove('hidden');
                currentPasswordField.querySelector('input').required = true;
            } else {
                currentPasswordField.classList.add('hidden');
                currentPasswordField.querySelector('input').required = false;
            }
        });

        // Закрытие модалки по клику вне окна
        document.getElementById('changePasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                toggleChangePasswordModal();
            }
        });

        // AJAX смена пароля
        document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const form = e.target;
            
            // Показываем загрузку на кнопке
            setChangePasswordButtonLoading(true);

            const formData = new FormData(form);
            const newPassword = formData.get('new_password');
            const confirmPassword = formData.get('confirm_password');
            const currentPassword = formData.get('current_password');

            // Валидация
            if (newPassword !== confirmPassword) {
                showChangePasswordButtonError("Пароли не совпадают");
                return;
            }

            if (newPassword.length < 6) {
                showChangePasswordButtonError("Пароль должен быть не менее 6 символов");
                return;
            }

            const csrfToken = form.querySelector('[name=csrfmiddlewaretoken]').value;

            try {
                const response = await fetch("{% url 'change_password' %}", {
                    method: "POST",
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData
                });

                const data = await response.json();
                
                if (data.success) {
                    // Успешная смена пароля
                    showChangePasswordButtonSuccess(data.message || "Пароль изменен!");
                    
                    // После первой успешной смены устанавливаем флаг в false
                    if (isFirstPasswordChange) {
                        isFirstPasswordChange = false;
                    }
                } else {
                    showChangePasswordButtonError(data.error || "Ошибка при смене пароля");
                }
            } catch (error) {
                console.error('Ошибка:', error);
                showChangePasswordButtonError("Ошибка соединения");
            }
        });
    </script>

  <script>

  
    // Передаем категории из Django в JavaScript
    window.categories = [
        {% for cat in categories %}
        {
            id: "{{ cat.id }}",
            name: "{{ cat.name|escapejs }}"
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Передача URL из Django в JavaScript
    window.ADD_TRANSACTION_URL = "{% url 'add_transaction' %}";
    window.STATIC_URL = "{% static '' %}";

  

    // Флаг нового пользователя для показа приветствия
    window.isNewUser = {% if is_new_user %}true{% else %}false{% endif %};


    // Инициализация при загрузке страницы
    document.addEventListener("DOMContentLoaded", function() {


        
        
        // Скрываем пустое состояние для фильтрованных категорий
        const emptyStateFiltered = document.getElementById('emptyStateFiltered');
        if (emptyStateFiltered) {
            emptyStateFiltered.classList.add('hidden');
        }
        
        // Инициализация системы фильтрации
        if (typeof window.initTransactionFilter === 'function') {

            window.initTransactionFilter();
        } else {
            console.error('Функция initTransactionFilter не найдена');
        }
        
        // Инициализация вкладок категорий
        if (typeof window.updateCategoryTabsHandlers === 'function') {
            window.updateCategoryTabsHandlers();
        }
    });
</script>

    

</body>
</html>